<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pflask &mdash; pflask 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="pflask 0.2 documentation" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">pflask 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pflask">
<h1>pflask<a class="headerlink" href="#pflask" title="Permalink to this headline">¶</a></h1>
<a class="reference external image-reference" href="https://travis-ci.org/ghedo/pflask"><img alt="https://travis-ci.org/ghedo/pflask.png" src="https://travis-ci.org/ghedo/pflask.png" /></a>
<p><a class="reference external" href="https://ghedo.github.io/pflask">pflask</a> is a simple tool for creating Linux namespace containers. It can be
used for running a command or even booting an OS inside an isolated container,
created with the help of Linux namespaces. It is similar in functionality to
<cite>chroot(8)</cite>, although pflask provides better isolation thanks to the use of
namespaces.</p>
<p>Compared to <a class="reference external" href="http://linuxcontainers.org">LXC</a>, pflask is easier to use since it doesn&#8217;t require any
pre-configuration (all the options can be passed via the command-line). pflask
is mostly intended for testing, building and experimenting, whereas LXC is a
more complete solution, better suited for production environments.</p>
<p>Compared to <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd-nspawn.html">systemd-nspawn</a>, pflask doesn&#8217;t require the use of systemd on the
host system and provides additional options for manipulating mount points and
network interfaces inside the container. On the other hand, systemd-nspawn is
better integrated in the systemd ecosystem.</p>
<p>Additionally, while most other containerization solutions (LXC, systemd-nspawn,
...) are mostly targeted at containing whole systems, pflask can also be used to
contain single programs, without the need to create ad-hoc chroots.</p>
<div class="section" id="features">
<h2>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<div class="section" id="user-namespace">
<h3>User namespace<a class="headerlink" href="#user-namespace" title="Permalink to this headline">¶</a></h3>
<p>When the host system allows it, pflask creates a new user namespace inside the
container, and automatically maps the user running pflask to the root user
inside the container. This means that a user could create and have full root
privileges inside a container, while having none on the host system.</p>
<p>Note that this has been the cause of security vulnerabilities in the past, so
that most OS vendors (reasonably) decided to either disable user namespace
support altogether, or restrict the functionality to root.</p>
<p>pflask can disable the relevant functionality when it detects that support for
user namespaces is not available.</p>
</div>
<div class="section" id="mount-namespace">
<h3>Mount namespace<a class="headerlink" href="#mount-namespace" title="Permalink to this headline">¶</a></h3>
<p>By default, pflask creates a new mount namespace inside the container, so that
filesystems mounted inside it won&#8217;t affect the host system. pflask can also be
told to create new mount points before the execution of the supplied command,
by using the <cite>&#8211;mount</cite> option. Supported mount point types are:</p>
<ul class="simple">
<li><cite>bind</cite>    &#8211; bind mount a directory/file to another directory/file</li>
<li><cite>bind-ro</cite> &#8211; like <cite>bind</cite>, but read-only</li>
<li><cite>overlay</cite> &#8211; stack a directory on top of another directory using AuFS or OVL</li>
<li><cite>tmp</cite>     &#8211; mount a tmpfs on a directory</li>
</ul>
</div>
<div class="section" id="network-namespace">
<h3>Network namespace<a class="headerlink" href="#network-namespace" title="Permalink to this headline">¶</a></h3>
<p>When supplied the <cite>&#8211;netif</cite> option, pflask will create a new network namespace
and move/rename the supplied network interface inside the container.</p>
</div>
<div class="section" id="pid-ipc-and-uts-namespaces">
<h3>PID, IPC and UTS namespaces<a class="headerlink" href="#pid-ipc-and-uts-namespaces" title="Permalink to this headline">¶</a></h3>
<p>By default, pflask creates new PID, IPC and UTS namespaces inside the container,
in order to isolate processes, IPC resources and the node/domain name of the
container from the host system.</p>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="hide-directories-from-an-application">
<h3>Hide directories from an application<a class="headerlink" href="#hide-directories-from-an-application" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pflask --user<span class="o">=</span><span class="nv">$USER</span> --mount<span class="o">=</span>tmp,<span class="nv">$HOME</span> chromium --disable-setuid-sandbox
</pre></div>
</div>
<p>This command does not require a pre-generated chroot (it will use the current
root) and will mount a tmpfs on <cite>$HOME</cite> so that the application (chromium in the
example) won&#8217;t be able to access your precious files. Any change will be also
discarded once the process terminates. A bind mount can be used to retain the
modifications:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pflask --user<span class="o">=</span><span class="nv">$USER</span> --mount<span class="o">=</span><span class="nb">bind</span>,/tmp/trash,<span class="nv">$HOME</span>  chromium --disable-setuid-sandbox
</pre></div>
</div>
<p>All filesystem changes applied by the command will be available in /tmp/trash.</p>
<p>Both commands can be run without root privileges as long as user namespaces are
supported by the host system, and available to non-privileged users.</p>
<p>For example, on Debian, user namespaces are enabled, but are restricted to root
only. To enable them for unprivileged users run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo sysctl kernel.unprivileged_userns_clone<span class="o">=</span>1
</pre></div>
</div>
</div>
<div class="section" id="detach-from-terminal">
<h3>Detach from terminal<a class="headerlink" href="#detach-from-terminal" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pflask --user<span class="o">=</span><span class="nv">$USER</span> --detach /bin/bash
</pre></div>
</div>
<p>To reattach run pflask with the <cite>&#8211;attach</cite> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pidof pflask
29076
<span class="nv">$ </span>pflask --attach<span class="o">=</span>29076
</pre></div>
</div>
<p>Where <cite>29076</cite> is the PID of the detached pflask process. Once reattached, one
can detach again by pressing <cite>^&#64;</cite> (Ctrl + &#64;).</p>
</div>
<div class="section" id="boot-the-os-inside-the-container">
<h3>Boot the OS inside the container<a class="headerlink" href="#boot-the-os-inside-the-container" title="Permalink to this headline">¶</a></h3>
<p>First create a base Debian system using <cite>debootstrap(8)</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo debootstrap --include<span class="o">=</span>systemd unstable /path/to/container
</pre></div>
</div>
<p>It is recommended to use systemd as init system inside the guest, since it can
detect whether it is run inside a container or not, and disable not needed
services accordingly.</p>
<p>Then create the container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/container /lib/systemd/systemd
</pre></div>
</div>
<p>This will simply execute the init system (systemd) inside the container. Replace
<cite>/lib/systemd/systemd</cite> with <cite>/sbin/init</cite> if you have a different init (but note
that there&#8217;s no guarantee that it&#8217;ll work).</p>
</div>
<div class="section" id="volatile-root">
<h3>Volatile root<a class="headerlink" href="#volatile-root" title="Permalink to this headline">¶</a></h3>
<p>By using the <cite>&#8211;volatile</cite> option it&#8217;s possible to tell pflask to discard any
change applied to the / directory once the container exits:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/container --volatile /lib/systemd/systemd
</pre></div>
</div>
<p>The above will overlay a tmpfs on top of the chroot <cite>/path/to/container</cite>
directory, so that the root filesystem will be writable from inside the
container, but any change will be disacarded once the container terminates.</p>
<p>This can be useful as a build environment, where dependencies can be installed
at every build run on a clean chroot, without the need to recreate the chroot
at every run.</p>
</div>
<div class="section" id="disable-network-inside-the-container">
<h3>Disable network inside the container<a class="headerlink" href="#disable-network-inside-the-container" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/container --netif /lib/systemd/systemd
</pre></div>
</div>
<p>Using the <cite>&#8211;netif</cite> option without any argument creates a new network namespace
inside the container without adding any new interface, therefore leaving the
_lo_ interface as the only one inside the container and disabling network access
to the outside world while at the same time leaving the network on the host
system working.</p>
</div>
<div class="section" id="use-a-private-network-interface-inside-the-container">
<h3>Use a private network interface inside the container<a class="headerlink" href="#use-a-private-network-interface-inside-the-container" title="Permalink to this headline">¶</a></h3>
<p>First, let&#8217;s create the new network interface thet will be used inside the
container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo ip link add name pflask-vlan0 link eth0 <span class="nb">type </span>macvlan
</pre></div>
</div>
<p>This will create a new interface, <cite>pflask-vlan0</cite>, of type <cite>macvlan</cite> using the
<cite>eth0</cite> interface on the host as master. <cite>macvlan</cite> interfaces can be used to
give a second MAC address to a network adapter (in this case <cite>eth0</cite>) and make
it look like a completely different device.</p>
<p>Finally, create the container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/container --netif<span class="o">=</span>pflask-vlan0,eth0 /lib/systemd/systemd
</pre></div>
</div>
<p>This will take the <cite>pflask-vlan0</cite> interface previously created, move it inside
the container and rename it to <cite>eth0</cite>. The container will thus have what it
looks like a private <cite>eth0</cite> network interface that can be configured
independently from the host <cite>eth0</cite>. Once the container terminates, its network
interface will be destroyed as well.</p>
<p>Note that <cite>macvlan</cite> is just one of the possibilities. One could create a pair
of <cite>veth</cite> interfaces, move one of them inside the container and connect the
other to a bridge (e.g. an Open VSwitch bridge). Alternatively one could create
a <cite>vxlan</cite> interface and connect the container to a VXLAN network, etc...</p>
</div>
<div class="section" id="copy-on-write-filesystem">
<h3>Copy-on-write filesystem<a class="headerlink" href="#copy-on-write-filesystem" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/container <span class="se">\</span>
  --mount<span class="o">=</span>overlay,/tmp/overlay/root,/path/to/container,/tmp/overlay/work <span class="se">\</span>
  /lib/systemd/systemd
</pre></div>
</div>
<p>This will mount a copy-on-write filesystem on the / of the container. Any change
to files and directories will be saved in <cite>/tmp/overlay</cite> so that the container
root directory (<cite>/path/to/container</cite>) will be unaffected.</p>
<p>Note that this requires support for either AuFS or OverlayFS on the host system.</p>
</div>
<div class="section" id="build-a-debian-package-inside-a-container">
<h3>Build a Debian package inside a container<a class="headerlink" href="#build-a-debian-package-inside-a-container" title="Permalink to this headline">¶</a></h3>
<p>First, create the base Debian system:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo mkdir -p /var/cache/pflask
<span class="nv">$ DIST</span><span class="o">=</span>sid pflask-debuild --create
</pre></div>
</div>
<p>Then retrieve the source package we want to build:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>apt-get <span class="nb">source </span>somepackage
<span class="nv">$ </span><span class="nb">cd </span>somepackage-XYX
</pre></div>
</div>
<p>Where _somepackage_ is the desired package, and _XYZ_ is the package version.</p>
<p>Finally build the package:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ DIST</span><span class="o">=</span>sid pflask-debuild
</pre></div>
</div>
<p>The script will take care of creating a new container, installing all the
required dependncies (inside the container), building and signing the package.</p>
<p>A copy-on-write filesystem is also mounted on the / of the container, so that
the same clean chroot can be re-used to build other packages.</p>
<p>Note that the <a class="reference external" href="https://ghedo.github.io/pflask/pflask-debuild.html">pflask-debuild</a> tool is far from perfect, and may not work in
all situations.</p>
<p>See the <a class="reference external" href="https://ghedo.github.io/pflask/pflask.html">man page</a> for more information.</p>
</div>
</div>
<div class="section" id="building">
<h2>Building<a class="headerlink" href="#building" title="Permalink to this headline">¶</a></h2>
<p>pflask is distributed as source code. Build with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>./bootstrap.py
<span class="nv">$ </span>./waf configure
<span class="nv">$ </span>./waf build
</pre></div>
</div>
</div>
<div class="section" id="copyright">
<h2>Copyright<a class="headerlink" href="#copyright" title="Permalink to this headline">¶</a></h2>
<p>Copyright (C) 2013 Alessandro Ghedini &lt;<a class="reference external" href="mailto:alessandro&#37;&#52;&#48;ghedini&#46;me">alessandro<span>&#64;</span>ghedini<span>&#46;</span>me</a>&gt;</p>
<p>See <a class="reference external" href="https://github.com/ghedo/pflask/tree/master/COPYING">COPYING</a> for the license.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">pflask</a><ul>
<li><a class="reference internal" href="#features">Features</a><ul>
<li><a class="reference internal" href="#user-namespace">User namespace</a></li>
<li><a class="reference internal" href="#mount-namespace">Mount namespace</a></li>
<li><a class="reference internal" href="#network-namespace">Network namespace</a></li>
<li><a class="reference internal" href="#pid-ipc-and-uts-namespaces">PID, IPC and UTS namespaces</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#hide-directories-from-an-application">Hide directories from an application</a></li>
<li><a class="reference internal" href="#detach-from-terminal">Detach from terminal</a></li>
<li><a class="reference internal" href="#boot-the-os-inside-the-container">Boot the OS inside the container</a></li>
<li><a class="reference internal" href="#volatile-root">Volatile root</a></li>
<li><a class="reference internal" href="#disable-network-inside-the-container">Disable network inside the container</a></li>
<li><a class="reference internal" href="#use-a-private-network-interface-inside-the-container">Use a private network interface inside the container</a></li>
<li><a class="reference internal" href="#copy-on-write-filesystem">Copy-on-write filesystem</a></li>
<li><a class="reference internal" href="#build-a-debian-package-inside-a-container">Build a Debian package inside a container</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building">Building</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">pflask 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Alessandro Ghedini.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>