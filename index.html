<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pflask &mdash; pflask 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="pflask 0.2 documentation" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">pflask 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pflask">
<h1>pflask<a class="headerlink" href="#pflask" title="Permalink to this headline">¶</a></h1>
<a class="reference external image-reference" href="https://travis-ci.org/ghedo/pflask"><img alt="https://travis-ci.org/ghedo/pflask.png" src="https://travis-ci.org/ghedo/pflask.png" /></a>
<p><a class="reference external" href="https://ghedo.github.io/pflask">pflask</a> is a simple tool for creating process containers on LInux. It can be
used for running single commands or even booting a whole operating system
inside an isolated environment, where the filesystem hierarchy, networking,
process tree, IPC subsystems and host/domain name can be insulated from the
host system and other containers.</p>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>pflask doesn&#8217;t need any configuration and can be run without any arguments
as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask
</pre></div>
</div>
<p>By default a new container will be created and a bash shell will be started,
but a custom command can also be specified:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask -- id
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gruppi</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</pre></div>
</div>
<p>The container can also be run inside a private root directory by using the
<tt class="docutils literal"><span class="pre">--chroot</span></tt> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/rootfs -- id
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gruppi</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</pre></div>
</div>
<p>This can be used, for example, as a replacement for the <tt class="docutils literal"><span class="pre">chroot(8)</span></tt> command.
It&#8217;s even possible to invoke the init binary and boot the whole operating
system inside the container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/rootfs -- /lib/systemd/systemd
</pre></div>
</div>
<p>Note that pflask doesn&#8217;t provide any support for creating the rootfs, but can
piggyback on existing tools. For example the <tt class="docutils literal"><span class="pre">debootstrap(8)</span></tt> command can be
used for creating a Debian rootfs as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo debootstrap sid /path/to/rootfs http://httpredir.debian.org/debian
</pre></div>
</div>
<p>For more information on pflask usage, have a look at the <a class="reference external" href="https://ghedo.github.io/pflask/pflask.html">man page</a>.</p>
<div class="section" id="networking">
<h3>Networking<a class="headerlink" href="#networking" title="Permalink to this headline">¶</a></h3>
<p>Using the <tt class="docutils literal"><span class="pre">--netif</span></tt> option the networking of the container will be
disconnected from the host system and all network interfaces will be made
unavailable to the container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --netif -- ip link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN mode DEFAULT group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">--netif</span></tt> option can also be used to create private network interfaces:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --netif<span class="o">=</span>macvlan,eth0,net0 -- ip link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN mode DEFAULT group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
5: net0@if2: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT group default
    link/ether 92:e4:c2:9b:a4:75 brd ff:ff:ff:ff:ff:ff link-netnsid 0
</pre></div>
</div>
<p>Interfaces created inside the container will be automatically destroyed once
the container terminates.</p>
<p>The command above will create a new <tt class="docutils literal"><span class="pre">macvlan</span></tt> interface called <tt class="docutils literal"><span class="pre">net0</span></tt>, from
the <tt class="docutils literal"><span class="pre">eth0</span></tt> host interface. <tt class="docutils literal"><span class="pre">macvlan</span></tt> interfaces can be used to give an
additional MAC address to a network adapter and make it look like a completely
different device.</p>
<p>pflask can also create other <a class="reference external" href="https://ghedo.github.io/pflask/pflask.html#netif">types of network interfaces</a>, have a look at the
manpage for more information.</p>
</div>
<div class="section" id="filesystem">
<h3>Filesystem<a class="headerlink" href="#filesystem" title="Permalink to this headline">¶</a></h3>
<p>By default a new mount namespace is created for the container, so that
filesystems mounted inside it won&#8217;t affect the host system. The <tt class="docutils literal"><span class="pre">--mount</span></tt>
option can then be used to create new mount points before the execution of the
supplied command.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/rootfs --mount<span class="o">=</span><span class="nb">bind</span>,/tmp,/tmp
</pre></div>
</div>
<p>The command above will bind mount the host&#8217;s <tt class="docutils literal"><span class="pre">/tmp</span></tt> directory into the
container&#8217;s <tt class="docutils literal"><span class="pre">/tmp</span></tt>, so that files can be exchanged between them.</p>
<p>pflask can also create other <a class="reference external" href="https://ghedo.github.io/pflask/pflask.html#mount">types of mount points</a>, have a look at the
manpage for more information.</p>
</div>
<div class="section" id="volatile-root-filesystem">
<h3>Volatile root filesystem<a class="headerlink" href="#volatile-root-filesystem" title="Permalink to this headline">¶</a></h3>
<p>Using the <tt class="docutils literal"><span class="pre">--volatile</span></tt> option it&#8217;s possible to tell pflask to discard any
change applied to the root filesystem once the container terminates:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/rootfs --volatile -- /lib/systemd/systemd
</pre></div>
</div>
<p>This can be used for example for a build environment, where dependencies can
be installed at every run on a clean rootfs, without the need to recreate the
rootfs every time.</p>
</div>
<div class="section" id="unprivileged-containers">
<h3>Unprivileged containers<a class="headerlink" href="#unprivileged-containers" title="Permalink to this headline">¶</a></h3>
<p>All the commands above have been executed with root privileges, but pflask can
be invoked, with some limitations, by unprivileged users as well, as long as
user namespaces are supported by the host system.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pflask --user<span class="o">=</span><span class="nv">$USER</span> -- id
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>ghedo<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>ghedo<span class="o">)</span> <span class="nv">gruppi</span><span class="o">=</span>1000<span class="o">(</span>ghedo<span class="o">)</span>
</pre></div>
</div>
<p>For example, on recent Debian versions user namespaces are enabled, but are
restricted to the root user only. To enable them for unprivileged users run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo sysctl kernel.unprivileged_userns_clone<span class="o">=</span>1
</pre></div>
</div>
<p>This functionality can be used to run every-day user applications such as a
web browser inside a container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pflask --user<span class="o">=</span><span class="nv">$USER</span> --mount<span class="o">=</span>tmp,<span class="nv">$HOME</span> -- chromium --disable-setuid-sandbox
</pre></div>
</div>
<p>The command above uses the <tt class="docutils literal"><span class="pre">--mount</span></tt> option to create a <tt class="docutils literal"><span class="pre">tmpfs</span></tt> mount point
on the <tt class="docutils literal"><span class="pre">$HOME</span></tt> directory, so that the application (chromium in the example)
won&#8217;t be able to access the user&#8217;s private files, and any modification to the
home directory will be discarded once the container terminates.</p>
<p>The <tt class="docutils literal"><span class="pre">--chroot</span></tt> option can be used with unprivileged containers as well, but
requires some additional configuration.</p>
<p>The first step is assigning a set of additional UIDs and GIDs to the current
user (<tt class="docutils literal"><span class="pre">$USER</span></tt>). These will be used by pflask inside the container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo usermod --add-subuids 100000-165535 <span class="nv">$USER</span>
<span class="nv">$ </span>sudo usermod --add-subgids 100000-165535 <span class="nv">$USER</span>
</pre></div>
</div>
<p>Note that the commands above require root privileges, but have to be run only
once.</p>
<p>Then any time an unprivileged <tt class="docutils literal"><span class="pre">chroot(8)</span></tt> is needed, the following command
can be run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pflask --user-map<span class="o">=</span>0:100000:65536 --chroot<span class="o">=</span>/path/to/rootfs
</pre></div>
</div>
<p>Note that the <tt class="docutils literal"><span class="pre">newuidmap(1)</span></tt> and <tt class="docutils literal"><span class="pre">newgidmap(1)</span></tt> commands need to be
installed for any of this to work: on Debian/Ubuntu systems they are provided
by the <tt class="docutils literal"><span class="pre">uidmap</span></tt> package.</p>
</div>
<div class="section" id="background-containers">
<h3>Background containers<a class="headerlink" href="#background-containers" title="Permalink to this headline">¶</a></h3>
<p>Containers can be detached from the current terminal as soon as they are
created by using the <tt class="docutils literal"><span class="pre">--detach</span></tt> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/rootfs --detach
</pre></div>
</div>
<p>and then later reattached (even to a different terminal) with the <tt class="docutils literal"><span class="pre">--attach</span></tt>
option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pidof pflask
29076
<span class="nv">$ </span>pflask --attach<span class="o">=</span>29076
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">29076</span></tt> is the PID of the detached pflask process. Once reattached, it
can be detached again by pressing <tt class="docutils literal"><span class="pre">^&#64;</span></tt> (Ctrl + &#64;).</p>
</div>
<div class="section" id="systemd-s-machined-integration">
<h3>systemd&#8217;s machined integration<a class="headerlink" href="#systemd-s-machined-integration" title="Permalink to this headline">¶</a></h3>
<p>Containers created with pflask are automatically registered with the <a class="reference external" href="http://www.freedesktop.org/wiki/Software/systemd/machined/">machined</a>
daemon, if installed and running. The <tt class="docutils literal"><span class="pre">machinectl(1)</span></tt> command can then be
used to list and manipulate running containers.</p>
<p>Let&#8217;s create one container as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pflask --chroot<span class="o">=</span>/path/to/rootfs -- /lib/systemd/systemd
</pre></div>
</div>
<p>Running containers can be listed using the <tt class="docutils literal"><span class="pre">list</span></tt> command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>machinectl --no-pager list
MACHINE      CLASS     SERVICE
pflask-19170 container pflask

<span class="m">1</span> machines listed.
</pre></div>
</div>
<p>and information regarding a single container can be retrieved with the <tt class="docutils literal"><span class="pre">show</span></tt>
command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>machinectl --no-pager show pflask-19170
<span class="nv">Name</span><span class="o">=</span>pflask-19170
<span class="nv">Id</span><span class="o">=</span>00000000000000000000000000000000
<span class="nv">Timestamp</span><span class="o">=</span>gio 2015-06-25 20:28:34 CEST
<span class="nv">TimestampMonotonic</span><span class="o">=</span>8860409172
<span class="nv">Service</span><span class="o">=</span>pflask
<span class="nv">Unit</span><span class="o">=</span>machine-pflask<span class="se">\x</span>5cx2d19170.scope
<span class="nv">Leader</span><span class="o">=</span>19170
<span class="nv">Class</span><span class="o">=</span>container
<span class="nv">RootDirectory</span><span class="o">=</span>/home/ghedo/local/debian
<span class="nv">State</span><span class="o">=</span>running
</pre></div>
</div>
<p>Additionally, the <tt class="docutils literal"><span class="pre">status</span></tt> command will show more information regarding the
status of the container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>machinectl --no-pager status pflask-19170
pflask-19170
        Since: gio 2015-06-25 20:28:34 CEST<span class="p">;</span> 1min 21s ago
       Leader: <span class="m">19170</span> <span class="o">(</span>systemd<span class="o">)</span>
      Service: pflask<span class="p">;</span> class container
         Root: /home/ghedo/local/debian
           OS: Debian GNU/Linux stretch/sid
         Unit: machine-pflask<span class="se">\x</span>2d19170.scope
               ├─19170 /lib/systemd/systemd
               └─system.slice
                 ├─systemd-journald.service
                 │ └─19184 /lib/systemd/systemd-journald
                 └─console-getty.service
                   └─19216 /sbin/agetty --noclear --keep-baud console <span class="m">115200</span> 3...

giu <span class="m">25</span> 20:28:34 kronk systemd<span class="o">[</span>1<span class="o">]</span>: Started Container pflask-19170.
giu <span class="m">25</span> 20:28:34 kronk systemd<span class="o">[</span>1<span class="o">]</span>: Starting Container pflask-19170.
</pre></div>
</div>
<p>One can even log into the container using the <tt class="docutils literal"><span class="pre">login</span></tt> command (note that
the dbus daemon needs to be running inside the container for this to work):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo machinectl login pflask-19170
Connected to machine pflask-19170. Press ^<span class="o">]</span> three <span class="nb">times </span>within 1s to <span class="nb">exit </span>session.

Debian GNU/Linux stretch/sid kronk pts/0

kronk login:
</pre></div>
</div>
<p>And finally the container can be terminated using either the <tt class="docutils literal"><span class="pre">poweroff</span></tt> or
<tt class="docutils literal"><span class="pre">terminate</span></tt> commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo machinectl poweroff pflask-19170
</pre></div>
</div>
</div>
</div>
<div class="section" id="building">
<h2>Building<a class="headerlink" href="#building" title="Permalink to this headline">¶</a></h2>
<p>pflask is distributed as source code. Build with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>./bootstrap.py
<span class="nv">$ </span>./waf configure
<span class="nv">$ </span>./waf build
</pre></div>
</div>
</div>
<div class="section" id="copyright">
<h2>Copyright<a class="headerlink" href="#copyright" title="Permalink to this headline">¶</a></h2>
<p>Copyright (C) 2013 Alessandro Ghedini &lt;<a class="reference external" href="mailto:alessandro&#37;&#52;&#48;ghedini&#46;me">alessandro<span>&#64;</span>ghedini<span>&#46;</span>me</a>&gt;</p>
<p>See <a class="reference external" href="https://github.com/ghedo/pflask/tree/master/COPYING">COPYING</a> for the license.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">pflask</a><ul>
<li><a class="reference internal" href="#getting-started">Getting Started</a><ul>
<li><a class="reference internal" href="#networking">Networking</a></li>
<li><a class="reference internal" href="#filesystem">Filesystem</a></li>
<li><a class="reference internal" href="#volatile-root-filesystem">Volatile root filesystem</a></li>
<li><a class="reference internal" href="#unprivileged-containers">Unprivileged containers</a></li>
<li><a class="reference internal" href="#background-containers">Background containers</a></li>
<li><a class="reference internal" href="#systemd-s-machined-integration">systemd&#8217;s machined integration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building">Building</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">pflask 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Alessandro Ghedini.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>